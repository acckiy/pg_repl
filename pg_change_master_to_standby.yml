---
  - name: Master->StandBy
    become: yes
    hosts: master
    tasks:
      - name: Stop service postgresql
        ansible.builtin.service:
          name: postgresql-15
          state: stopped

      - name: Remove data dir
        ansible.builtin.file:
          path: "/var/lib/pgsql/15/data"
          state: absent

      - name: Create data dir
        ansible.builtin.file:
          path: "/var/lib/pgsql/15/data"
          state: directory
          owner: postgres
          group: postgres
          mode: '0700'

      - name: Get backup DB
        become_user: postgres
        ansible.builtin.shell: "pg_basebackup -R -h {{ hostvars[item].ansible_host }} -U repluser -D /var/lib/pgsql/15/data -S replislot"
        with_items: "{{ groups.standby }}"
      
      - name: Start service postgresql
        ansible.builtin.service:
          name: postgresql-15
          state: started

